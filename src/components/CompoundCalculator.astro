---
const frequencies = [
  { label: "Ročne", value: "1" },
  { label: "Štvrťročne", value: "4" },
  { label: "Mesačne", value: "12" }
];
const { id="kalkulacka" } = Astro.props;
---

<section id={id} class="bg-white">
  <div class="page-container-narrow py-16 lg:py-20">
    <div class="flex items-baseline justify-between border-b border-neutral-200 pb-4">
      <h2 class="text-neutral-900">Kalkulačka zloženého úročenia</h2>
      <span class="eyebrow text-xs text-neutral-500">EUR</span>
    </div>

    <div class="mt-10 grid gap-10 lg:grid-cols-12">
      <form id="compound-form" class="space-y-6 lg:col-span-7">
        <label class="grid gap-2 text-sm text-neutral-600">
          Počiatočný vklad
          <input
            id="principal"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            value="4000"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          />
        </label>

        <label class="grid gap-2 text-sm text-neutral-600">
          Ročná úroková sadzba (%)
          <input
            id="rate"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.1"
            value="5"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          />
        </label>

        <label class="grid gap-2 text-sm text-neutral-600">
          Frekvencia zloženého úročenia
          <select
            id="compound-frequency"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          >
            {frequencies.map((item) => (
              <option value={item.value}>{item.label}</option>
            ))}
          </select>
        </label>

        <label class="grid gap-2 text-sm text-neutral-600">
          Dĺžka investície (v rokoch)
          <input
            id="years"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.5"
            value="10"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          />
        </label>

        <label class="grid gap-2 text-sm text-neutral-600">
          Pravidelný vklad
          <input
            id="contribution"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            value="0"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          />
        </label>

        <label class="grid gap-2 text-sm text-neutral-600">
          Frekvencia vkladu
          <select
            id="contribution-frequency"
            class="w-full rounded-md border border-neutral-200 bg-white px-4 py-2 text-neutral-900 shadow-sm focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-200"
          >
            {frequencies.map((item) => (
              <option value={item.value}>{item.label}</option>
            ))}
          </select>
        </label>

        <button type="submit" class="button-primary">
          Výpočet
        </button>
      </form>

      <div class="lg:col-span-5">
        <div class="rounded-2xl border border-neutral-200 bg-neutral-50 p-6">
          <h3 class="text-neutral-900">Výsledok</h3>
          <div class="mt-6 space-y-4">
            <div class="flex items-center justify-between gap-4">
              <span class="text-sm text-neutral-600">Budúca hodnota</span>
              <output id="future-value" class="text-lg font-medium text-neutral-900">€0.00</output>
            </div>
            <div class="flex items-center justify-between gap-4">
              <span class="text-sm text-neutral-600">Celkový vklad</span>
              <output id="total-contribution" class="text-lg font-medium text-neutral-900">€0.00</output>
            </div>
            <div class="flex items-center justify-between gap-4">
              <span class="text-sm text-neutral-600">Získané úroky</span>
              <output id="interest-earned" class="text-lg font-medium text-neutral-900">€0.00</output>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById("compound-form");
  const principalInput = document.getElementById("principal");
  const rateInput = document.getElementById("rate");
  const compoundSelect = document.getElementById("compound-frequency");
  const yearsInput = document.getElementById("years");
  const contributionInput = document.getElementById("contribution");
  const contributionSelect = document.getElementById("contribution-frequency");
  const futureValueOutput = document.getElementById("future-value");
  const totalContributionOutput = document.getElementById("total-contribution");
  const interestOutput = document.getElementById("interest-earned");

  const formatter = new Intl.NumberFormat("sk-SK", {
    style: "currency",
    currency: "EUR"
  });

  const toNumber = (value) => {
    const clean = String(value).replace(/[^0-9.-]/g, "");
    const parsed = Number.parseFloat(clean);
    return Number.isFinite(parsed) ? parsed : 0;
  };

  const monthlyRate = (annualRate, compoundingPerYear) => {
    if (!annualRate || !compoundingPerYear) return 0;
    return Math.pow(1 + annualRate / compoundingPerYear, compoundingPerYear / 12) - 1;
  };

  const calculate = () => {
    const principal = Math.max(0, toNumber(principalInput.value));
    const annualRate = Math.max(0, toNumber(rateInput.value)) / 100;
    const years = Math.max(0, toNumber(yearsInput.value));
    const contribution = Math.max(0, toNumber(contributionInput.value));
    const compoundFrequency = Math.max(1, Number.parseInt(compoundSelect.value, 10) || 1);
    const contributionFrequency = Math.max(1, Number.parseInt(contributionSelect.value, 10) || 1);

    const totalMonths = Math.max(0, Math.round(years * 12));
    const ratePerMonth = monthlyRate(annualRate, compoundFrequency);
    const contributionInterval = 12 / contributionFrequency;

    let balance = principal;
    let totalContribution = principal;

    for (let month = 1; month <= totalMonths; month += 1) {
      if (ratePerMonth > 0) {
        balance *= 1 + ratePerMonth;
      }

      if (contribution > 0 && month % contributionInterval === 0) {
        balance += contribution;
        totalContribution += contribution;
      }
    }

    const interestEarned = Math.max(0, balance - totalContribution);

    futureValueOutput.textContent = formatter.format(balance);
    totalContributionOutput.textContent = formatter.format(totalContribution);
    interestOutput.textContent = formatter.format(interestEarned);
  };

  form?.addEventListener("submit", (event) => {
    event.preventDefault();
    calculate();
  });

  [principalInput, rateInput, yearsInput, contributionInput, compoundSelect, contributionSelect].forEach(
    (input) => input?.addEventListener("input", calculate)
  );

  calculate();
</script>
